<div class="bg-white shadow rounded-lg">
  <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
    <div class="flex items-center justify-between gap-3 flex-wrap">
      <div>
        <h3 class="text-lg leading-6 font-medium text-gray-900">Administración · Usuarios</h3>
        <p class="mt-1 text-sm text-gray-500">Listado de usuarios con búsqueda y paginación.</p>
      </div>
      <div class="flex items-center gap-2">
        <% if (user && user.role === 'admin') { %>
          <a href="/admin/usuarios/nuevo" class="inline-flex items-center px-3 py-2 rounded-md border text-sm hover:bg-gray-50" title="Nuevo Usuario" aria-label="Nuevo Usuario">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-5 w-5 text-gray-600" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 6v12M6 12h12"/></svg>
            <span class="sr-only">Nuevo Usuario</span>
          </a>
        <% } %>
        <form method="get" class="flex items-center gap-2">
          <input type="text" name="search" value="<%= (pagination && pagination.search) || '' %>" placeholder="Buscar usuario/rol..." class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
          <button class="px-3 py-2 rounded-md bg-blue-600 text-white text-sm hover:bg-blue-700">Buscar</button>
        </form>
      </div>
    </div>
  </div>
  <div class="px-4 py-5 sm:p-6">
    <% if (users && users.length) { %>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rol</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Creado</th>
              <% if (user && user.role === 'admin') { %>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
              <% } %>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% users.forEach(u => { %>
              <tr>
                <td class="px-4 py-2 text-sm text-gray-900"><%= u.username %></td>
                <td class="px-4 py-2 text-sm text-gray-700"><%= u.email %></td>
                <td class="px-4 py-2 text-sm text-gray-700 capitalize">
                  <% if (user && user.role === 'admin') { %>
                    <form id="form-rol-<%= u._id %>" action="/admin/usuarios/<%= u._id %>/rol" method="post" class="inline-flex items-center gap-2">
                      <select name="role" class="border border-gray-300 rounded px-2 py-1 text-xs capitalize">
                        <% ['admin','analista','supervisor','asesor'].forEach(r => { %>
                          <option value="<%= r %>" <%= u.role === r ? 'selected' : '' %>><%= r %></option>
                        <% }) %>
                      </select>
                      <button type="button" onclick="openConfirm('form-rol-<%= u._id %>','¿Confirmas cambiar el rol de este usuario?')" class="p-1.5 rounded hover:bg-gray-100 text-gray-600" title="Guardar rol" aria-label="Guardar rol">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-5 w-5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 12.75l6 6 9-13.5"/></svg>
                      </button>
                    </form>
                  <% } else { %>
                    <%= u.role %>
                  <% } %>
                </td>
                <td class="px-4 py-2 text-sm text-gray-700"><%= u.createdAt ? new Date(u.createdAt).toLocaleString() : '-' %></td>
                <% if (user && user.role === 'admin') { %>
                <td class="px-4 py-2 text-sm text-gray-700 text-right">
                  <form id="form-reset-<%= u._id %>" action="/admin/usuarios/<%= u._id %>/reset" method="post" class="inline">
                    <button type="button" onclick="openConfirm('form-reset-<%= u._id %>','¿Resetear la contraseña a temporal123?')" class="p-1.5 text-gray-600 hover:text-red-700" title="Resetear contraseña" aria-label="Resetear contraseña">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-5 w-5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15.75 9V7.5a3.75 3.75 0 10-7.5 0V9"/><rect x="6" y="9" width="12" height="9" rx="2"/><path d="M12 12v3"/></svg>
                    </button>
                  </form>
                </td>
                <% } %>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <div class="mt-4 flex items-center justify-between text-sm text-gray-600">
        <div>
          Página <%= pagination.page %> de <%= pagination.totalPages %> · Total: <%= pagination.total %>
        </div>
        <div class="flex gap-2">
          <% const prev = Math.max(pagination.page - 1, 1); const next = Math.min(pagination.page + 1, pagination.totalPages); %>
          <a href="?page=<%= prev %>&perPage=<%= pagination.perPage %>&search=<%= encodeURIComponent(pagination.search || '') %>" class="px-3 py-1 border rounded hover:bg-gray-50 <%= pagination.page === 1 ? 'pointer-events-none opacity-50' : '' %>">Anterior</a>
          <a href="?page=<%= next %>&perPage=<%= pagination.perPage %>&search=<%= encodeURIComponent(pagination.search || '') %>" class="px-3 py-1 border rounded hover:bg-gray-50 <%= pagination.page === pagination.totalPages ? 'pointer-events-none opacity-50' : '' %>">Siguiente</a>
        </div>
      </div>
    <% } else { %>
      <p class="text-sm text-gray-500">No hay usuarios para mostrar.</p>
    <% } %>
  </div>
</div>

<div id="confirmModal" class="hidden fixed z-50 inset-0 overflow-y-auto" role="dialog" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen px-4">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75" onclick="closeConfirm()"></div>
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full z-10">
      <div class="px-4 py-3 border-b">
        <h3 class="text-sm font-medium text-gray-900">Confirmación</h3>
      </div>
      <div class="px-4 py-4">
        <p id="confirmMessage" class="text-sm text-gray-700"></p>
      </div>
      <div class="px-4 py-3 border-t flex justify-end gap-2">
        <button type="button" class="px-3 py-1.5 rounded border text-sm" onclick="closeConfirm()">Cancelar</button>
        <button type="button" class="px-3 py-1.5 rounded bg-blue-600 text-white text-sm hover:bg-blue-700" onclick="submitConfirm()">Confirmar</button>
      </div>
    </div>
  </div>
  <form id="__confirmFormHelper" class="hidden"></form>
  <input type="hidden" id="__confirmTargetId" />
  <input type="hidden" id="__confirmMessageText" />
</div>

<script>
  function openConfirm(formId, message) {
    document.getElementById('__confirmTargetId').value = formId;
    document.getElementById('confirmMessage').textContent = message || '¿Confirmas esta acción?';
    document.getElementById('confirmModal').classList.remove('hidden');
  }
  function closeConfirm() {
    document.getElementById('confirmModal').classList.add('hidden');
  }
  function submitConfirm() {
    var formId = document.getElementById('__confirmTargetId').value;
    if (formId) {
      document.getElementById(formId).submit();
    }
    closeConfirm();
  }
</script>
