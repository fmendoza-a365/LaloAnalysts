<div class="space-y-3 sm:space-y-6">
  <!-- Filtros de periodo y supervisor -->
  <div class="bg-white shadow rounded-lg p-3 sm:p-4">
    <form method="GET" action="/asistencia" class="flex flex-col sm:flex-row sm:flex-wrap gap-3 sm:gap-4 items-stretch sm:items-end">
      <div class="flex-1 min-w-[140px]">
        <label for="anio" class="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-2">Año</label>
        <input type="number" min="2000" max="2100" id="anio" name="anio" value="<%= periodo.anio %>" class="block w-full border-2 border-gray-200 rounded-lg shadow-sm px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition text-sm font-medium">
      </div>
      <div class="flex-1 min-w-[180px]">
        <label for="mes" class="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-2">Mes</label>
        <select id="mes" name="mes" class="block w-full border-2 border-gray-200 rounded-lg shadow-sm px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition text-sm font-medium">
          <% for (let i=1;i<=12;i++){ %>
            <option value="<%= i %>" <%= periodo.mes===i ? 'selected' : '' %>><%= String(i).padStart(2,'0') %> - <%= ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][i-1] %></option>
          <% } %>
        </select>
      </div>
      <div class="flex-1 min-w-[200px]">
        <label for="supervisor" class="block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-2">Supervisor</label>
        <select id="supervisor" name="supervisor" class="block w-full border-2 border-gray-200 rounded-lg shadow-sm px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition text-sm font-medium">
          <option value="">Todos los Supervisores</option>
          <% (todosLosSupervisores || []).forEach(sup => { %>
            <option value="<%= sup %>" <%= filtros.supervisor === sup ? 'selected' : '' %>><%= sup %></option>
          <% }) %>
        </select>
      </div>
      <button type="submit" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition-colors">
        Consultar
      </button>
    </form>
  </div>

  <% if (noData) { %>
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
      <p class="text-yellow-800 font-medium">No hay datos de asistencia cargados para <%= periodo.anio %>-<%= String(periodo.mes).padStart(2,'0') %></p>
      <p class="text-yellow-600 text-sm mt-2">Carga un archivo CSV desde el módulo de <a href="/admin/asistencia" class="underline">Administración → Asistencia</a></p>
    </div>
  <% } else { %>
    <!-- KPIs de Asistencia -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-white shadow rounded-lg p-4 border-l-4 border-blue-500">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Total Registros</div>
        <div class="text-2xl font-bold text-gray-900"><%= kpis.totalRegistros %></div>
      </div>
      <div class="bg-white shadow rounded-lg p-4 border-l-4 border-green-500">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Asistencias Puntuales</div>
        <div class="text-2xl font-bold text-gray-900"><%= kpis.asistenciasPuntuales %></div>
        <div class="text-xs text-gray-500 mt-1"><%= kpis.porcentajeAsistencia %>%</div>
      </div>
      <div class="bg-white shadow rounded-lg p-4 border-l-4 border-red-500">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Faltas Injustificadas</div>
        <div class="text-2xl font-bold text-gray-900"><%= kpis.faltasInjustificadas %></div>
        <div class="text-xs text-gray-500 mt-1"><%= kpis.porcentajeFaltas %>%</div>
      </div>
      <div class="bg-white shadow rounded-lg p-4 border-l-4 border-yellow-500">
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Tardanzas</div>
        <div class="text-2xl font-bold text-gray-900"><%= kpis.tardanzas %></div>
      </div>
    </div>

    <!-- Gráfico de Estados -->
    <div class="bg-white shadow rounded-lg p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Distribución por Estado</h3>
      <canvas id="estadosChart" height="80"></canvas>
    </div>

    <!-- Top 20 Asesores por Asistencia -->
    <div class="bg-white shadow rounded-lg p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Top 20 Asesores por Asistencia</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Asesor</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Supervisor</th>
              <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Total Días</th>
              <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Puntuales</th>
              <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Faltas</th>
              <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Tardanzas</th>
              <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">% Asistencia</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% asistenciaPorAsesor.forEach(a => { %>
              <tr>
                <td class="px-3 py-2 text-gray-900"><%= a.nombre %></td>
                <td class="px-3 py-2 text-gray-700"><%= a.supervisor || '-' %></td>
                <td class="px-3 py-2 text-center text-gray-700"><%= a.totalDias %></td>
                <td class="px-3 py-2 text-center text-green-600 font-semibold"><%= a.puntuales %></td>
                <td class="px-3 py-2 text-center text-red-600 font-semibold"><%= a.faltas %></td>
                <td class="px-3 py-2 text-center text-yellow-600 font-semibold"><%= a.tardanzas %></td>
                <td class="px-3 py-2 text-center">
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold <%= a.porcentajeAsistencia >= 95 ? 'bg-green-100 text-green-800' : a.porcentajeAsistencia >= 85 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800' %>">
                    <%= a.porcentajeAsistencia %>%
                  </span>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  <% } %>
</div>

<% if (!noData) { %>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
  // Gráfico de Estados
  const estadosCtx = document.getElementById('estadosChart');
  new Chart(estadosCtx, {
    type: 'bar',
    data: {
      labels: <%- JSON.stringify(estadisticasPorEstado.map(e => e.estado)) %>,
      datasets: [{
        label: 'Cantidad',
        data: <%- JSON.stringify(estadisticasPorEstado.map(e => e.count)) %>,
        backgroundColor: [
          'rgba(34, 197, 94, 0.7)',
          'rgba(239, 68, 68, 0.7)',
          'rgba(59, 130, 246, 0.7)',
          'rgba(168, 85, 247, 0.7)',
          'rgba(234, 179, 8, 0.7)'
        ],
        borderColor: [
          'rgb(34, 197, 94)',
          'rgb(239, 68, 68)',
          'rgb(59, 130, 246)',
          'rgb(168, 85, 247)',
          'rgb(234, 179, 8)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        },
        title: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        }
      }
    }
  });
</script>
<% } %>
