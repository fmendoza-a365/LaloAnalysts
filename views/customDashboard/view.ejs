<!-- GridStack CSS (para mantener el mismo layout) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@9.5.1/dist/gridstack.min.css" />
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
.grid-stack-item-content {
  background: transparent;
  border-radius: 12px;
  box-shadow: none;
  overflow: visible;
  display: flex;
  flex-direction: column;
}

.widget-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 16px;
  color: white;
}

.widget-title {
  font-size: 18px;
  font-weight: 700;
  margin: 0;
}

.widget-subtitle {
  font-size: 12px;
  opacity: 0.9;
  margin-top: 4px;
}

.widget-body {
  flex: 1;
  padding: 24px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.widget-body-fullscreen {
  width: 100%;
  height: 100%;
  padding: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.modern-kpi-card {
  width: 100%;
  height: 100%;
  border-radius: 12px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: clamp(12px, 3%, 24px);
}

.kpi-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: clamp(8px, 2%, 16px);
  width: 100%;
}

.kpi-text {
  flex: 1;
  min-width: 0; /* Permite que el texto se ajuste */
}

.kpi-title {
  font-size: clamp(10px, 1.2vw, 14px);
  opacity: 0.9;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: clamp(4px, 1%, 8px);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.kpi-value-display {
  font-size: clamp(20px, 4vw, 48px);
  font-weight: 800;
  line-height: 1;
  word-break: break-word;
}

.kpi-icon {
  font-size: clamp(24px, 5vw, 64px);
  opacity: 0.3;
  flex-shrink: 0;
}

/* Tarjetas modernas para gr√°ficos y tablas */
.modern-widget-card {
  width: 100%;
  height: 100%;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.widget-card-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: clamp(12px, 2%, 16px);
  flex-shrink: 0;
}

.widget-card-title {
  font-size: clamp(14px, 1.5vw, 18px);
  font-weight: 700;
  color: white;
  margin: 0;
  line-height: 1.2;
}

.widget-card-subtitle {
  font-size: clamp(10px, 1vw, 12px);
  color: rgba(255, 255, 255, 0.9);
  display: block;
  margin-top: 4px;
}

.widget-card-body {
  flex: 1;
  padding: clamp(12px, 2%, 20px);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  overflow: auto;
}

.widget-card-body canvas {
  max-width: 100%;
  max-height: 100%;
}

.kpi-value {
  font-size: 48px;
  font-weight: 800;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.kpi-label {
  font-size: 14px;
  color: #6b7280;
  text-transform: uppercase;
  font-weight: 600;
  letter-spacing: 0.05em;
  margin-top: 8px;
}

.loading-spinner {
  border: 3px solid #f3f4f6;
  border-top: 3px solid #8b5cf6;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Sistema de Modal Personalizado */
.custom-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.custom-modal-overlay.show {
  opacity: 1;
}

.custom-modal {
  background: white;
  border-radius: 16px;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  max-width: 500px;
  width: 90%;
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.custom-modal-overlay.show .custom-modal {
  transform: scale(1);
}

.custom-modal-header {
  padding: 24px 24px 16px 24px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.custom-modal-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  flex-shrink: 0;
}

.custom-modal-icon.success {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
}

.custom-modal-icon.error {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: white;
}

.custom-modal-icon.warning {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
}

.custom-modal-icon.info {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: white;
}

.custom-modal-title {
  font-size: 20px;
  font-weight: 700;
  color: #111827;
}

.custom-modal-body {
  padding: 0 24px 24px 24px;
}

.custom-modal-message {
  color: #4b5563;
  line-height: 1.6;
  white-space: pre-line;
}

.custom-modal-footer {
  padding: 16px 24px;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  border-radius: 0 0 16px 16px;
}

.custom-modal-button {
  padding: 10px 24px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
  outline: none;
}

.custom-modal-button.primary {
  background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  color: white;
  box-shadow: 0 4px 6px -1px rgba(139, 92, 246, 0.2);
}

.custom-modal-button.primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 8px -1px rgba(139, 92, 246, 0.3);
}

.custom-modal-button.secondary {
  background: white;
  color: #6b7280;
  border: 1px solid #d1d5db;
}

.custom-modal-button.secondary:hover {
  background: #f9fafb;
}
</style>

<!-- Header -->
<div class="bg-gradient-to-r from-purple-600 to-indigo-700 rounded-lg shadow-2xl mb-6">
  <div class="px-6 py-6">
    <div class="flex items-center justify-between">
      <div class="flex-1">
        <h1 class="text-3xl font-bold text-white mb-2"><%= dashboard.name %></h1>
        <% if (dashboard.description) { %>
          <p class="text-purple-100"><%= dashboard.description %></p>
        <% } %>
      </div>
      <div class="flex gap-3">
        <% if (dashboard.createdBy.toString() === user._id.toString()) { %>
          <a href="/custom-dashboard/editor?id=<%= dashboard._id %>" class="inline-flex items-center px-4 py-2 bg-white/20 text-white font-semibold rounded-lg hover:bg-white/30 transition-all">
            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            Editar
          </a>
        <% } %>
        <button onclick="saveLayout()" class="inline-flex items-center px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-all">
          <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
          </svg>
          Guardar Layout
        </button>
        <button onclick="refreshDashboard()" class="inline-flex items-center px-4 py-2 bg-white/20 text-white font-semibold rounded-lg hover:bg-white/30 transition-all">
          <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          Actualizar
        </button>
        <a href="/custom-dashboard" class="inline-flex items-center px-4 py-2 bg-white text-purple-700 font-bold rounded-lg shadow-lg hover:bg-purple-50 transition-all">
          <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          Volver
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Filtros Globales -->
<div class="bg-white rounded-lg shadow-lg p-4 mb-6">
  <form id="filtersForm" class="flex flex-wrap gap-4 items-end">
    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-2">A√±o</label>
      <select name="anio" id="filterAnio" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500">
        <% for (let y = 2023; y <= 2030; y++) { %>
          <option value="<%= y %>" <%= y === new Date().getFullYear() ? 'selected' : '' %>><%= y %></option>
        <% } %>
      </select>
    </div>
    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-2">Mes</label>
      <select name="mes" id="filterMes" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500">
        <% for (let m = 1; m <= 12; m++) { %>
          <option value="<%= m %>" <%= m === (new Date().getMonth() + 1) ? 'selected' : '' %>>
            <%= ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][m-1] %>
          </option>
        <% } %>
      </select>
    </div>
    <div>
      <button type="button" onclick="applyFilters()" class="px-6 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-all">
        Aplicar Filtros
      </button>
    </div>
  </form>
</div>

<!-- Dashboard Canvas -->
<div class="bg-gray-50 rounded-xl p-6">
  <div class="grid-stack" id="dashboardCanvas"></div>
</div>

<!-- Modal Personalizado -->
<div id="customModalOverlay" class="custom-modal-overlay" style="display: none;">
  <div class="custom-modal">
    <div class="custom-modal-header">
      <div id="customModalIcon" class="custom-modal-icon success">
        ‚úì
      </div>
      <h3 id="customModalTitle" class="custom-modal-title">√âxito</h3>
    </div>
    <div class="custom-modal-body">
      <p id="customModalMessage" class="custom-modal-message">Operaci√≥n completada correctamente</p>
    </div>
    <div class="custom-modal-footer">
      <button id="customModalButton" class="custom-modal-button primary">Aceptar</button>
    </div>
  </div>
</div>

<!-- GridStack JS -->
<script src="https://cdn.jsdelivr.net/npm/gridstack@9.5.1/dist/gridstack-all.js"></script>

<script>
let grid;
const dashboardData = <%- JSON.stringify(dashboard) %>;
const widgetDataMap = new Map();

/**
 * Sistema de Modal Personalizado
 * Reemplaza los alert() del navegador con modales estilizados
 */
function showModal(message, type = 'success', title = null, callback = null) {
  const overlay = document.getElementById('customModalOverlay');
  const icon = document.getElementById('customModalIcon');
  const titleEl = document.getElementById('customModalTitle');
  const messageEl = document.getElementById('customModalMessage');
  const button = document.getElementById('customModalButton');

  // Configurar tipo de modal
  const types = {
    success: { icon: '‚úì', title: '√âxito', class: 'success' },
    error: { icon: '‚úï', title: 'Error', class: 'error' },
    warning: { icon: '‚ö†', title: 'Advertencia', class: 'warning' },
    info: { icon: '‚Ñπ', title: 'Informaci√≥n', class: 'info' }
  };

  const config = types[type] || types.info;

  // Aplicar configuraci√≥n
  icon.textContent = config.icon;
  icon.className = `custom-modal-icon ${config.class}`;
  titleEl.textContent = title || config.title;
  messageEl.textContent = message;

  // Mostrar modal con animaci√≥n
  overlay.style.display = 'flex';
  setTimeout(() => overlay.classList.add('show'), 10);

  // Configurar bot√≥n
  const closeModal = () => {
    overlay.classList.remove('show');
    setTimeout(() => {
      overlay.style.display = 'none';
      if (callback) callback();
    }, 300);
  };

  // Event listeners
  button.onclick = closeModal;
  overlay.onclick = (e) => {
    if (e.target === overlay) closeModal();
  };

  // Cerrar con ESC
  const handleEsc = (e) => {
    if (e.key === 'Escape') {
      closeModal();
      document.removeEventListener('keydown', handleEsc);
    }
  };
  document.addEventListener('keydown', handleEsc);
}

document.addEventListener('DOMContentLoaded', function() {
  // Inicializar GridStack en modo editable
  grid = GridStack.init({
    float: false,
    cellHeight: 80,
    minRow: 1,
    column: 12,
    margin: 12,
    staticGrid: false, // Editable
    disableDrag: false,
    disableResize: false,
    resizable: {
      handles: 'e, se, s, sw, w'
    }
  });

  // Cargar widgets
  loadDashboard();
});

async function loadDashboard() {
  if (!dashboardData.widgets || dashboardData.widgets.length === 0) {
    document.getElementById('dashboardCanvas').innerHTML = `
      <div class="text-center py-20">
        <svg class="h-24 w-24 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
        </svg>
        <h3 class="text-xl font-bold text-gray-400 mb-2">Dashboard sin widgets</h3>
        <p class="text-gray-400">Este dashboard no tiene widgets configurados</p>
      </div>
    `;
    return;
  }

  // Renderizar cada widget
  for (const widget of dashboardData.widgets) {
    await renderWidget(widget);
  }
}

async function renderWidget(widget) {
  // Todos los widgets sin header - ocupan 100% del espacio
  const content = `
    <div class="widget-body-fullscreen" id="widget-body-${widget.id}" style="width: 100%; height: 100%; padding: 0;">
      <div class="loading-spinner" style="margin: auto;"></div>
    </div>
  `;

  grid.addWidget({
    x: widget.position?.x || 0,
    y: widget.position?.y || 0,
    w: widget.position?.width || 4,
    h: widget.position?.height || 3,
    content: content,
    id: widget.id
  });

  // Cargar datos del widget
  await loadWidgetData(widget);
}

async function loadWidgetData(widget) {
  try {
    const filters = {
      anio: document.getElementById('filterAnio').value,
      mes: document.getElementById('filterMes').value
    };

    const response = await fetch('/custom-dashboard/api/widget-data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ widget, filters })
    });

    const result = await response.json();

    if (result.success) {
      widgetDataMap.set(widget.id, result.data);
      displayWidget(widget, result.data);
    } else {
      showWidgetError(widget.id, result.error || 'Error al cargar datos');
    }
  } catch (error) {
    console.error('Error loading widget data:', error);
    showWidgetError(widget.id, 'Error de conexi√≥n');
  }
}

function displayWidget(widget, data) {
  const bodyEl = document.getElementById(`widget-body-${widget.id}`);

  if (!bodyEl) return;

  if (widget.type === 'kpi') {
    const kpiConfig = widget.kpiConfig || {};
    const bgColor = kpiConfig.backgroundColor || '#10b981';
    const textColor = kpiConfig.textColor || '#ffffff';
    const icon = kpiConfig.icon || 'fa-chart-line';
    const format = kpiConfig.format || 'number';

    bodyEl.innerHTML = `
      <div class="modern-kpi-card" style="background: ${bgColor}; color: ${textColor};">
        <div class="kpi-content">
          <div class="kpi-text">
            <div class="kpi-title">
              ${widget.title}
            </div>
            <div class="kpi-value-display">
              ${formatKpiValue(data.value, format)}
            </div>
          </div>
          <div class="kpi-icon">
            <i class="fa-solid ${icon}"></i>
          </div>
        </div>
      </div>
    `;
  } else if (widget.type === 'chart') {
    bodyEl.innerHTML = `
      <div class="w-full h-full p-4 bg-white rounded-lg shadow-lg">
        <canvas id="chart-${widget.id}"></canvas>
      </div>
    `;

    setTimeout(() => {
      renderChart(widget, data);
    }, 100);
  } else if (widget.type === 'table') {
    bodyEl.innerHTML = `
      <div class="w-full h-full bg-white rounded-lg shadow-lg overflow-auto" id="table-container-${widget.id}">
      </div>
    `;

    renderTable(widget, data, document.getElementById(`table-container-${widget.id}`));
  }
}

function renderChart(widget, data) {
  const canvas = document.getElementById(`chart-${widget.id}`);
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const chartType = widget.chartConfig?.chartType || 'bar';

  console.log('[VIEW] Renderizando gr√°fico:', widget.title);
  console.log('[VIEW] Data recibida:', data);
  console.log('[VIEW] Tipo de gr√°fico:', chartType);

  // üé® Funci√≥n helper para convertir hex a rgba
  const hexToRgba = (hex, alpha) => {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  };

  // üé® Obtener color del primer campo calculado (si existe)
  const firstField = widget.dataConfig?.calculatedFields?.[0];
  const baseColor = firstField?.color || '#8b5cf6'; // Default morado
  const fieldLabel = firstField?.label || widget.title;

  console.log('[VIEW] üé® Color personalizado:', baseColor, '- Etiqueta:', fieldLabel);

  let chartData;

  // Verificar si hay datos agrupados (data.data es un array con elementos)
  if (data.data && Array.isArray(data.data) && data.data.length > 0) {
    console.log('[VIEW] ‚úÖ Datos agrupados detectados:', data.data.length, 'grupos');

    // Para gr√°ficos circulares (pie/doughnut), cada segmento tiene su color
    // Para otros gr√°ficos, todas las barras/puntos tienen el mismo color
    let bgColors, borderColors;

    if (chartType === 'pie' || chartType === 'doughnut') {
      // Colores diferentes para cada segmento
      bgColors = getChartColors(data.data.length, false);
      borderColors = getChartColors(data.data.length, true);
    } else {
      // Mismo color personalizado para todas las barras/l√≠neas
      const bgAlpha = chartType === 'line' ? 0.2 : 0.8;
      bgColors = Array(data.data.length).fill(hexToRgba(baseColor, bgAlpha));
      borderColors = Array(data.data.length).fill(baseColor);
    }

    chartData = {
      labels: data.data.map(d => d.label),
      datasets: [{
        label: fieldLabel,
        data: data.data.map(d => d.value),
        backgroundColor: bgColors,
        borderColor: borderColors,
        borderWidth: 2,
        fill: chartType === 'area'
      }]
    };
  } else {
    // Sin agrupaci√≥n - valor √∫nico
    console.log('[VIEW] ‚ö†Ô∏è Sin agrupaci√≥n, mostrando valor √∫nico:', data.value);
    chartData = {
      labels: ['Valor'],
      datasets: [{
        label: fieldLabel,
        data: [data.value || 0],
        backgroundColor: [hexToRgba(baseColor, 0.8)],
        borderColor: [baseColor],
        borderWidth: 2
      }]
    };
  }

  console.log('[VIEW] ChartData preparada:', chartData);

  new Chart(ctx, {
    type: chartType === 'area' ? 'line' : chartType,
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: chartType === 'pie' || chartType === 'doughnut'
        },
        title: {
          display: true,
          text: data.data && data.data.length > 0
            ? `${widget.title} (${data.data.length} grupos)`
            : widget.title
        }
      },
      scales: chartType !== 'pie' && chartType !== 'doughnut' ? {
        y: { beginAtZero: true }
      } : {}
    }
  });
}

function renderTable(widget, data, bodyEl) {
  // Si no hay datos agrupados, mostrar el valor √∫nico en una tabla simple
  if (!data.data || data.data.length === 0) {
    if (data.value !== undefined && data.value !== null) {
      bodyEl.innerHTML = `
        <div class="w-full overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700 uppercase">M√©trica</th>
                <th class="px-4 py-2 text-right text-xs font-semibold text-gray-700 uppercase">Valor</th>
              </tr>
            </thead>
            <tbody class="bg-white">
              <tr>
                <td class="px-4 py-2 text-sm text-gray-900">${widget.dataConfig?.aggregation?.type.toUpperCase() || 'TOTAL'}</td>
                <td class="px-4 py-2 text-sm text-gray-900 text-right font-semibold">${formatValue(data.value, widget)}</td>
              </tr>
            </tbody>
          </table>
        </div>
      `;
      return;
    }
    bodyEl.innerHTML = '<p class="text-gray-500 text-center">Sin datos disponibles. Configura un campo para agrupar.</p>';
    return;
  }

  let tableHTML = `
    <div class="w-full overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700 uppercase">Categor√≠a</th>
            <th class="px-4 py-2 text-right text-xs font-semibold text-gray-700 uppercase">Valor</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
  `;

  data.data.forEach(row => {
    tableHTML += `
      <tr>
        <td class="px-4 py-2 text-sm text-gray-900">${row.label}</td>
        <td class="px-4 py-2 text-sm text-gray-900 text-right font-semibold">${formatValue(row.value, widget)}</td>
      </tr>
    `;
  });

  tableHTML += `
        </tbody>
      </table>
    </div>
  `;

  bodyEl.innerHTML = tableHTML;
}

function formatKpiValue(value, format) {
  if (value === null || value === undefined) return '0';

  const numValue = parseFloat(value);

  if (isNaN(numValue)) return '0';

  switch (format) {
    case 'percentage':
      return numValue.toFixed(2) + '%';

    case 'currency':
      return 'S/ ' + numValue.toLocaleString('es-PE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    case 'time':
      // Convertir segundos a HH:MM:SS
      const hours = Math.floor(numValue / 3600);
      const minutes = Math.floor((numValue % 3600) / 60);
      const seconds = Math.floor(numValue % 60);
      return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

    case 'number':
    default:
      // N√∫mero normal - Si es entero, sin decimales; si tiene decimales, exactamente 2
      if (Number.isInteger(numValue)) {
        return numValue.toLocaleString('es-PE');
      }
      return numValue.toLocaleString('es-PE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
}

function formatValue(value, widget) {
  if (value === null || value === undefined) return '0';

  const numValue = parseFloat(value);

  // Si es f√≥rmula personalizada con %, agregar s√≠mbolo
  if (widget.dataConfig?.aggregation?.customFormula?.includes('* 100')) {
    return numValue.toFixed(2) + '%';
  }

  // Si el campo es moneda
  if (widget.dataConfig?.field?.includes('costo') || widget.dataConfig?.field?.includes('sueldo')) {
    return 'S/ ' + numValue.toLocaleString('es-PE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  // N√∫mero normal - Si es entero, sin decimales; si tiene decimales, exactamente 2
  if (Number.isInteger(numValue)) {
    return numValue.toLocaleString('es-PE');
  }

  return numValue.toLocaleString('es-PE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function getDatasetLabel(dataset) {
  const labels = {
    provision: 'Provisi√≥n',
    asistencia: 'Asistencia',
    genesys: 'Genesys',
    nomina: 'N√≥mina',
    asesores: 'Asesores'
  };
  return labels[dataset] || dataset;
}

function getChartColors(count, border = false) {
  const colors = [
    border ? 'rgba(139, 92, 246, 1)' : 'rgba(139, 92, 246, 0.6)',
    border ? 'rgba(59, 130, 246, 1)' : 'rgba(59, 130, 246, 0.6)',
    border ? 'rgba(16, 185, 129, 1)' : 'rgba(16, 185, 129, 0.6)',
    border ? 'rgba(245, 158, 11, 1)' : 'rgba(245, 158, 11, 0.6)',
    border ? 'rgba(239, 68, 68, 1)' : 'rgba(239, 68, 68, 0.6)',
    border ? 'rgba(236, 72, 153, 1)' : 'rgba(236, 72, 153, 0.6)'
  ];

  const result = [];
  for (let i = 0; i < count; i++) {
    result.push(colors[i % colors.length]);
  }
  return result;
}

function showWidgetError(widgetId, message) {
  const bodyEl = document.getElementById(`widget-body-${widgetId}`);
  if (bodyEl) {
    bodyEl.innerHTML = `
      <div class="text-center">
        <svg class="h-12 w-12 mx-auto text-red-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p class="text-sm text-red-600 font-semibold">${message}</p>
      </div>
    `;
  }
}

async function applyFilters() {
  // Limpiar grid
  grid.removeAll();

  // Recargar widgets con nuevos filtros
  for (const widget of dashboardData.widgets) {
    await renderWidget(widget);
  }
}

function refreshDashboard() {
  applyFilters();
}

// Guardar el layout actualizado
async function saveLayout() {
  try {
    // Obtener el estado actual de todos los widgets
    const items = grid.save(false);

    // Actualizar las posiciones y tama√±os en dashboardData
    dashboardData.widgets.forEach(widget => {
      const gridItem = items.find(item => item.id === widget.id);
      if (gridItem) {
        widget.x = gridItem.x;
        widget.y = gridItem.y;
        widget.w = gridItem.w;
        widget.h = gridItem.h;
      }
    });

    // Enviar al servidor para guardar
    const response = await fetch(`/custom-dashboard/${dashboardData._id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        name: dashboardData.name,
        description: dashboardData.description,
        widgets: dashboardData.widgets
      })
    });

    if (response.ok) {
      showModal('El layout del dashboard se ha guardado exitosamente', 'success', 'Layout Guardado');
    } else {
      const error = await response.json();
      showModal('Error al guardar: ' + (error.error || 'Error desconocido'), 'error', 'Error al Guardar');
    }
  } catch (error) {
    console.error('Error al guardar layout:', error);
    showModal('Error al guardar el layout. Por favor, intenta nuevamente.', 'error', 'Error de Conexi√≥n');
  }
}
</script>
